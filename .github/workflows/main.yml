name: CI
run-name: ${{ github.actor }} is deploying DevResultsTools
env:
  ARTIFACT_NAME: PowerShell.DevResultTools.InstanceExport
on:
  - push
jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3
      - name: Generating self signing certificate
        run: |
          cd ./InstanceExport/PowerShell;
          $params = @{
            Subject = 'CN=PowerShell Code Signing Cert'
            Type = 'CodeSigning'
            CertStoreLocation = 'Cert:\CurrentUser\My'
            HashAlgorithm = 'sha256'
          };
          $cert = New-SelfSignedCertificate @params;
          Get-ChildItem cert:\CurrentUser\my -codesigning;
          $cert = @(Get-ChildItem cert:\CurrentUser\My -codesigning)[0];
          Export-Certificate -FilePath exported_cert.cer -Cert $cert
          Import-Certificate -FilePath exported_cert.cer -CertStoreLocation Cert:\CurrentUser\Root
          Set-AuthenticodeSignature Add-Signature.ps1 $cert
        shell: pwsh
      - name: Adding self signature to InstanceExport script
        run: |
        cd ./InstanceExport/PowerShell;
        ./Add-Signature.ps1 -file InstanceExport.ps1
        shell: pwsh
      - name: Publish artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./InstanceExport/PowerShell/InstanceExport.ps1
